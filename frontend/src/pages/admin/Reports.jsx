import { useState } from 'react';
import { useTranslation } from 'react-i18next';
import api from '../../services/api';
import { FileBarChart, Download, Calendar } from 'lucide-react';
import { useContext } from 'react';
import { ToastContext } from '../../contexts/toastContext';

export default function ReportsPage() {
  const { t } = useTranslation();
  const { addToast } = useContext(ToastContext);
  const [startDate, setStartDate] = useState('');
  const [endDate, setEndDate] = useState('');
  const [loading, setLoading] = useState(false);
  const [report, setReport] = useState(null);

  async function handleGenerate(e) {
    e.preventDefault();
    setLoading(true);
    try {
      const params = new URLSearchParams();
      if (startDate) params.set('startDate', startDate);
      if (endDate) params.set('endDate', endDate);
      const res = await api.getRevenueReport(params.toString());
      setReport(res.data);
      addToast(t('common.success'), 'success');
    } catch (err) { addToast(err.message || t('common.error'), 'error'); }
    finally { setLoading(false); }
  }

  async function downloadFile(type) {
    try {
      if (!startDate || !endDate) {
        addToast(t('reports.messages.select_dates') || 'Please select start and end dates', 'error');
        return;
      }

      const params = new URLSearchParams();
      params.set('startDate', startDate);
      params.set('endDate', endDate);
      
      const endpoint = type === 'pdf' ? `/reports/revenue/pdf?${params}` : `/reports/revenue/excel?${params}`;
      const response = await fetch(`/api/v1${endpoint}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('accessToken')}` }
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({ message: response.statusText }));
        throw new Error(error.message || t('common.error'));
      }

      const blob = await response.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `revenue-report-${startDate}.${type === 'pdf' ? 'pdf' : 'xlsx'}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (err) { 
      addToast(err.message || t('common.error'), 'error'); 
    }
  }

  return (
    <div>
      <div className="page-header">
        <div>
          <h1 className="page-title">{t('reports.title')}</h1>
          <p className="page-subtitle">{t('reports.subtitle')}</p>
        </div>
      </div>

      <div className="card mb-md">
        <form onSubmit={handleGenerate} className="flex items-center gap-md" style={{ flexWrap: 'wrap' }}>
          <div className="form-group" style={{ marginBottom: 0 }}>
            <label className="form-label">{t('reports.filter.start')}</label>
            <input type="date" className="form-input" value={startDate} onChange={e => setStartDate(e.target.value)} />
          </div>
          <div className="form-group" style={{ marginBottom: 0 }}>
            <label className="form-label">{t('reports.filter.end')}</label>
            <input type="date" className="form-input" value={endDate} onChange={e => setEndDate(e.target.value)} />
          </div>
          <button type="submit" className="btn btn-primary" disabled={loading} style={{ alignSelf: 'flex-end' }}>
            {loading ? <span className="spinner"></span> : <FileBarChart size={18} />}
            {t('reports.filter.generate')}
          </button>
          <div style={{ display: 'flex', gap: '0.5rem', alignSelf: 'flex-end' }}>
            <button type="button" className="btn btn-secondary btn-sm" onClick={() => downloadFile('pdf')}>
              <Download size={14} /> PDF
            </button>
            <button type="button" className="btn btn-secondary btn-sm" onClick={() => downloadFile('excel')}>
              <Download size={14} /> Excel
            </button>
          </div>
        </form>
      </div>

      {report && (
        <div>
          <div className="grid grid-4" style={{ gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', marginBottom: 'var(--space-lg)' }}>
            <div className="stat-card">
              <div className="stat-icon" style={{ background: 'rgba(16, 185, 129, 0.12)', color: '#10b981' }}><FileBarChart size={24} /></div>
              <div>
                <div className="stat-value">{report.totalRevenue?.toFixed(2) || '0.00'} EGP</div>
                <div className="stat-label">{t('reports.stats.revenue')}</div>
              </div>
            </div>
            <div className="stat-card">
              <div className="stat-icon" style={{ background: 'rgba(99, 102, 241, 0.12)', color: '#6366f1' }}><Calendar size={24} /></div>
              <div>
                <div className="stat-value">{report.tripCount || 0}</div>
                <div className="stat-label">{t('reports.stats.trips')}</div>
              </div>
            </div>
            <div className="stat-card">
              <div className="stat-icon" style={{ background: 'rgba(239, 68, 68, 0.12)', color: '#ef4444' }}><Download size={24} /></div>
              <div>
                <div className="stat-value">{report.totalExpenses?.toFixed(2) || '0.00'} EGP</div>
                <div className="stat-label">{t('reports.stats.expenses')}</div>
              </div>
            </div>
            <div className="stat-card">
              <div className="stat-icon" style={{ background: 'rgba(16, 185, 129, 0.12)', color: '#10b981' }}><FileBarChart size={24} /></div>
              <div>
                <div className="stat-value">{report.netRevenue?.toFixed(2) || '0.00'} EGP</div>
                <div className="stat-label">{t('reports.stats.net')}</div>
              </div>
            </div>
          </div>

          {report.driverSummaries?.length > 0 && (
            <div className="card">
              <div className="card-header">
                <h3 className="card-title">{t('reports.card.title')}</h3>
              </div>
              <div className="table-container" style={{ border: 'none' }}>
                <table>
                  <thead>
                    <tr>
                      <th>{t('reports.table.driver')}</th>
                      <th>{t('reports.table.trips')}</th>
                      <th>{t('reports.table.revenue')}</th>
                      <th>{t('reports.table.expenses')}</th>
                      <th>{t('reports.table.net')}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {report.driverSummaries.map((d, i) => (
                      <tr key={i}>
                        <td style={{ fontWeight: 500 }}>{d.driverName}</td>
                        <td>{d.tripCount}</td>
                        <td>{d.totalRevenue?.toFixed(2)} EGP</td>
                        <td>{d.totalExpenses?.toFixed(2)} EGP</td>
                        <td>{d.netRevenue?.toFixed(2)} EGP</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
