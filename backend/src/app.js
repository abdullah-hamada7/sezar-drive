const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const morgan = require('morgan');
const compression = require('compression');

const rateLimit = require('express-rate-limit');
const config = require('./config');
const prisma = require('./config/database');
const { attachIp } = require('./middleware/audit');
const errorHandler = require('./middleware/errorHandler');
const i18n = require('./middleware/i18n');

// Rate limit auth endpoints to mitigate brute force and token abuse
const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: config.isProduction ? 30 : 1000, // Strict in production, relaxed for dev/testing
  message: { error: { code: 'TOO_MANY_REQUESTS', message: 'Too many attempts. Try again later.' } },
  standardHeaders: true,
  legacyHeaders: false,
});

// Module routes
const authRoutes = require('./modules/auth/auth.routes');
const driverRoutes = require('./modules/driver/driver.routes');
const vehicleRoutes = require('./modules/vehicle/vehicle.routes');
const shiftRoutes = require('./modules/shift/shift.routes');
const tripRoutes = require('./modules/trip/trip.routes');
const inspectionRoutes = require('./modules/inspection/inspection.routes');
const expenseRoutes = require('./modules/expense/expense.routes');
const damageRoutes = require('./modules/damage/damage.routes');
const trackingRoutes = require('./modules/tracking/tracking.routes');
const reportRoutes = require('./modules/report/report.routes');
const auditRoutes = require('./modules/audit/audit.routes');

const app = express();

// Trust proxy only when behind a reverse proxy (e.g., Caddy)
const trustProxy = config.isProduction || ['1', 'true', 'yes'].includes(String(process.env.TRUST_PROXY || '').toLowerCase());
app.set('trust proxy', trustProxy ? 1 : false);

app.use(
  helmet({
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        scriptSrc: ["'self'", "'unsafe-inline'", 'https://cdn.jsdelivr.net'],
        styleSrc: ["'self'", "'unsafe-inline'", 'https://fonts.googleapis.com'],
        imgSrc: ["'self'", 'data:', 'https://*.s3.amazonaws.com'],
        connectSrc: ["'self'", 'https://*.s3.amazonaws.com'],
        fontSrc: ["'self'", 'https://fonts.gstatic.com'],
        objectSrc: ["'none'"],
        upgradeInsecureRequests: [],
      },
    },
  })
);

// CORS: supports web frontend, packaged Electron (origin="null"), and mobile/native clients (no origin header).
const configuredOrigins = (process.env.CORS_ORIGIN || '')
  .split(',')
  .map((s) => s.trim())
  .filter(Boolean);
const allowNullOrigin = process.env.CORS_ALLOW_NULL_ORIGIN !== 'false';

const corsOptions = {
  origin(origin, callback) {
    // Native/mobile clients and server-to-server requests often omit Origin.
    if (!origin) return callback(null, true);

    // In development allow all browser origins for faster local iteration.
    if (!config.isProduction && configuredOrigins.length === 0) {
      return callback(null, true);
    }

    if (configuredOrigins.includes('*') || configuredOrigins.includes(origin)) {
      return callback(null, true);
    }

    // Packaged Electron loads from file:// and sends Origin: null
    if (origin === 'null' && (allowNullOrigin || configuredOrigins.includes('null'))) {
      return callback(null, true);
    }

    return callback(new Error(`CORS blocked for origin: ${origin}`));
  },
  credentials: true,
};
app.use(cors(corsOptions));
app.use(compression());

app.use(express.json({ limit: '20mb' }));
app.use(express.urlencoded({ extended: true }));

if (config.nodeEnv !== 'test') {
  app.use(morgan('combined'));
}

app.use(attachIp);
app.use(i18n);

app.get('/api/v1/health', (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() });
});

// Readiness: verifies basic DB connectivity.
app.get('/api/v1/ready', async (req, res) => {
  try {
    await prisma.$queryRaw`SELECT 1`;
    res.json({ status: 'ready', timestamp: new Date().toISOString() });
  } catch (e) {
    res.status(503).json({ status: 'not_ready', timestamp: new Date().toISOString() });
  }
});

app.use('/api/v1/auth', authLimiter, authRoutes);
app.use('/api/v1/drivers', driverRoutes);
app.use('/api/v1/vehicles', vehicleRoutes);
app.use('/api/v1/shifts', shiftRoutes);
app.use('/api/v1/trips', tripRoutes);
app.use('/api/v1/inspections', inspectionRoutes);
app.use('/api/v1/expenses', expenseRoutes);
app.use('/api/v1/damage-reports', damageRoutes);
app.use('/api/v1/tracking', trackingRoutes);
app.use('/api/v1/reports', reportRoutes);
app.use('/api/v1/stats', require('./modules/stats/stats.routes'));
app.use('/api/v1/verify', require('./modules/verification/verification.routes'));
app.use('/api/v1/audit-logs', auditRoutes);

app.use((req, res) => {
  res.status(404).json({ error: { code: 'NOT_FOUND', message: `Route ${req.method} ${req.path} not found` } });
});

app.use(errorHandler);

module.exports = app;
