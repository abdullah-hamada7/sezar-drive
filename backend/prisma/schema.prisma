generator client {
  provider      = "prisma-client-js"
  engineType    = "library"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                 @id @default(uuid()) @db.Uuid
  email                   String                 @unique @db.VarChar(255)
  phone                   String                 @unique @db.VarChar(20)
  passwordHash            String                 @map("password_hash") @db.VarChar(255)
  name                    String                 @db.VarChar(255)
  role                    String                 @db.VarChar(20)
  licenseNumber           String?                @unique @map("license_number") @db.VarChar(50)
  mustChangePassword      Boolean                @default(true) @map("must_change_password")
  identityVerified        Boolean                @default(false) @map("identity_verified")
  identityPhotoUrl        String?                @map("identity_photo_url") @db.VarChar(500)
  lastKnownLat            Decimal?               @map("last_known_lat") @db.Decimal(10, 7)
  lastKnownLng            Decimal?               @map("last_known_lng") @db.Decimal(10, 7)
  lastLocationAt          DateTime?              @map("last_location_at") @db.Timestamptz(6)
  isActive                Boolean                @default(true) @map("is_active")
  version                 Int                    @default(1)
  createdAt               DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime               @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  idCardBack              String?                @map("id_card_back") @db.VarChar(500)
  idCardFront             String?                @map("id_card_front") @db.VarChar(500)
  languagePreference      String                 @default("en") @map("language_preference") @db.VarChar(5)
  avatarUrl               String?                @map("profile_photo_url") @db.VarChar(500)
  lastBiometricVerifiedAt DateTime?              @map("last_biometric_verified_at") @db.Timestamptz(6)
  configUpdates           AdminConfig[]
  auditLogsAsActor        AuditLog[]             @relation("AuditActor")
  damageReports           DamageReport[]
  reviewedDamage          DamageReport[]         @relation("DamageReviewer")
  expenses                Expense[]
  reviewedExpenses        Expense[]              @relation("ExpenseReviewer")
  identityVerifications   IdentityVerification[]
  reviewedIdentities      IdentityVerification[] @relation("IdentityReviewer")
  inspections             Inspection[]
  locationLogs            LocationLog[]
  refreshTokens           RefreshToken[]
  shifts                  Shift[]
  cancelledTrips          Trip[]                 @relation("TripCanceller")
  trips                   Trip[]
  vehicleAssignments      VehicleAssignment[]
  devices                 UserDevice[]

  @@map("users")
}

model UserDevice {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  deviceFingerprint String   @map("device_fingerprint") @db.VarChar(255)
  deviceName        String?  @map("device_name") @db.VarChar(255)
  isVerified        Boolean  @default(false) @map("is_verified")
  lastUsedAt        DateTime @default(now()) @map("last_used_at") @db.Timestamptz(6)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user              User     @relation(fields: [userId], references: [id])

  @@unique([userId, deviceFingerprint])
  @@map("user_devices")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @map("token_hash") @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("refresh_tokens")
}

model IdentityVerification {
  id              String    @id @default(uuid()) @db.Uuid
  driverId        String    @map("driver_id") @db.Uuid
  photoUrl        String    @map("photo_url") @db.VarChar(500)
  status          String    @default("pending") @db.VarChar(20)
  reviewedBy      String?   @map("reviewed_by") @db.Uuid
  rejectionReason String?   @map("rejection_reason")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  reviewedAt      DateTime? @map("reviewed_at") @db.Timestamptz(6)
  idCardBack      String?   @map("id_card_back") @db.VarChar(500)
  idCardFront     String?   @map("id_card_front") @db.VarChar(500)
  driver          User      @relation(fields: [driverId], references: [id])
  reviewer        User?     @relation("IdentityReviewer", fields: [reviewedBy], references: [id])

  @@index([driverId])
  @@index([status])
  @@map("identity_verifications")
}

model Vehicle {
  id            String              @id @default(uuid()) @db.Uuid
  plateNumber   String              @unique @map("plate_number") @db.VarChar(20)
  model         String              @db.VarChar(100)
  year          Int
  capacity      Int                 @default(4)
  qrCode        String              @unique @map("qr_code") @db.VarChar(255)
  status        String              @default("available") @db.VarChar(20)
  isActive      Boolean             @default(true) @map("is_active")
  version       Int                 @default(1)
  createdAt     DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime            @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  damageReports DamageReport[]
  inspections   Inspection[]
  shifts        Shift[]
  trips         Trip[]
  assignments   VehicleAssignment[]

  @@map("vehicles")
}

model VehicleAssignment {
  id         String    @id @default(uuid()) @db.Uuid
  vehicleId  String    @map("vehicle_id") @db.Uuid
  driverId   String    @map("driver_id") @db.Uuid
  shiftId    String    @map("shift_id") @db.Uuid
  active     Boolean   @default(true)
  assignedAt DateTime  @default(now()) @map("assigned_at") @db.Timestamptz(6)
  releasedAt DateTime? @map("released_at") @db.Timestamptz(6)
  driver     User      @relation(fields: [driverId], references: [id])
  shift      Shift     @relation(fields: [shiftId], references: [id])
  vehicle    Vehicle   @relation(fields: [vehicleId], references: [id])

  @@index([vehicleId])
  @@index([driverId])
  @@index([shiftId])
  @@map("vehicle_assignments")
}

model Shift {
  id                 String                   @id @default(uuid()) @db.Uuid
  driverId           String                   @map("driver_id") @db.Uuid
  vehicleId          String?                  @map("vehicle_id") @db.Uuid
  status             String                   @default("PendingVerification") @db.VarChar(20)
  startedAt          DateTime?                @map("started_at") @db.Timestamptz(6)
  closedAt           DateTime?                @map("closed_at") @db.Timestamptz(6)
  closeReason        String?                  @map("close_reason") @db.VarChar(50)
  version            Int                      @default(1)
  createdAt          DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  rejectionReason    String?                  @map("rejection_reason") @db.VarChar(500)
  startSelfieUrl     String?                  @map("start_selfie_url") @db.VarChar(500)
  verificationStatus DriverVerificationStatus @default(PENDING) @map("verification_status")
  expenses           Expense[]
  inspections        Inspection[]
  locationLogs       LocationLog[]
  driver             User                     @relation(fields: [driverId], references: [id])
  vehicle            Vehicle?                 @relation(fields: [vehicleId], references: [id])
  trips              Trip[]
  assignments        VehicleAssignment[]

  @@index([driverId])
  @@index([status])
  @@index([createdAt])
  @@map("shifts")
}

model Trip {
  id                 String         @id @default(uuid()) @db.Uuid
  driverId           String         @map("driver_id") @db.Uuid
  shiftId            String         @map("shift_id") @db.Uuid
  vehicleId          String         @map("vehicle_id") @db.Uuid
  pickupLocation     String         @map("pickup_location") @db.VarChar(500)
  dropoffLocation    String         @map("dropoff_location") @db.VarChar(500)
  scheduledTime      DateTime?      @map("scheduled_time") @db.Timestamptz(6)
  price              Decimal        @db.Decimal(10, 2)
  actualStartTime    DateTime?      @map("actual_start_time") @db.Timestamptz(6)
  actualEndTime      DateTime?      @map("actual_end_time") @db.Timestamptz(6)
  cancellationReason String?        @map("cancellation_reason")
  cancelledBy        String?        @map("cancelled_by") @db.Uuid
  version            Int            @default(1)
  createdAt          DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime       @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  passengers         Json?          @map("passengers")
  status             TripState      @default(ASSIGNED)
  damageReports      DamageReport[]
  locationLogs       LocationLog[]
  canceller          User?          @relation("TripCanceller", fields: [cancelledBy], references: [id])
  driver             User           @relation(fields: [driverId], references: [id])
  shift              Shift          @relation(fields: [shiftId], references: [id])
  vehicle            Vehicle        @relation(fields: [vehicleId], references: [id])

  @@index([driverId])
  @@index([shiftId])
  @@index([vehicleId])
  @@index([status])
  @@index([actualEndTime])
  @@map("trips")
}

model Inspection {
  id            String            @id @default(uuid()) @db.Uuid
  shiftId       String            @map("shift_id") @db.Uuid
  vehicleId     String            @map("vehicle_id") @db.Uuid
  driverId      String            @map("driver_id") @db.Uuid
  type          String            @db.VarChar(20)
  status        String            @default("pending") @db.VarChar(20)
  mileage       Int?
  checklistData Json?             @map("checklist_data")
  createdAt     DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  completedAt   DateTime?         @map("completed_at") @db.Timestamptz(6)
  photos        InspectionPhoto[]
  driver        User              @relation(fields: [driverId], references: [id])
  shift         Shift             @relation(fields: [shiftId], references: [id])
  vehicle       Vehicle           @relation(fields: [vehicleId], references: [id])

  @@index([shiftId])
  @@index([vehicleId])
  @@index([driverId])
  @@map("inspections")
}

model InspectionPhoto {
  id           String     @id @default(uuid()) @db.Uuid
  inspectionId String     @map("inspection_id") @db.Uuid
  direction    String     @db.VarChar(10)
  photoUrl     String     @map("photo_url") @db.VarChar(500)
  uploadedAt   DateTime   @default(now()) @map("uploaded_at") @db.Timestamptz(6)
  inspection   Inspection @relation(fields: [inspectionId], references: [id])

  @@map("inspection_photos")
}

model ExpenseCategory {
  id               String    @id @default(uuid()) @db.Uuid
  name             String    @unique @db.VarChar(100)
  isActive         Boolean   @default(true) @map("is_active")
  requiresApproval Boolean   @default(false) @map("requires_approval")
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  expenses         Expense[]

  @@map("expense_categories")
}

model Expense {
  id              String          @id @default(uuid()) @db.Uuid
  shiftId         String          @map("shift_id") @db.Uuid
  driverId        String          @map("driver_id") @db.Uuid
  categoryId      String          @map("category_id") @db.Uuid
  amount          Decimal         @db.Decimal(10, 2)
  description     String?
  receiptUrl      String?         @map("receipt_url") @db.VarChar(500)
  status          String          @default("pending") @db.VarChar(20)
  reviewedBy      String?         @map("reviewed_by") @db.Uuid
  reviewedAt      DateTime?       @map("reviewed_at") @db.Timestamptz(6)
  rejectionReason String?         @map("rejection_reason")
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  category        ExpenseCategory @relation(fields: [categoryId], references: [id])
  driver          User            @relation(fields: [driverId], references: [id])
  reviewer        User?           @relation("ExpenseReviewer", fields: [reviewedBy], references: [id])
  shift           Shift           @relation(fields: [shiftId], references: [id])

  @@index([shiftId])
  @@index([driverId])
  @@index([categoryId])
  @@index([status])
  @@map("expenses")
}

model DamageReport {
  id          String        @id @default(uuid()) @db.Uuid
  vehicleId   String        @map("vehicle_id") @db.Uuid
  driverId    String        @map("driver_id") @db.Uuid
  tripId      String?       @map("trip_id") @db.Uuid
  shiftId     String        @map("shift_id") @db.Uuid
  description String
  status      String        @default("reported") @db.VarChar(20)
  reviewedBy  String?       @map("reviewed_by") @db.Uuid
  resolvedAt  DateTime?     @map("resolved_at") @db.Timestamptz(6)
  createdAt   DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime      @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  photos      DamagePhoto[]
  driver      User          @relation(fields: [driverId], references: [id])
  reviewer    User?         @relation("DamageReviewer", fields: [reviewedBy], references: [id])
  trip        Trip?         @relation(fields: [tripId], references: [id])
  vehicle     Vehicle       @relation(fields: [vehicleId], references: [id])

  @@index([vehicleId])
  @@index([driverId])
  @@index([shiftId])
  @@map("damage_reports")
}

model DamagePhoto {
  id             String       @id @default(uuid()) @db.Uuid
  damageReportId String       @map("damage_report_id") @db.Uuid
  photoUrl       String       @map("photo_url") @db.VarChar(500)
  uploadedAt     DateTime     @default(now()) @map("uploaded_at") @db.Timestamptz(6)
  damageReport   DamageReport @relation(fields: [damageReportId], references: [id])

  @@map("damage_photos")
}

model LocationLog {
  id         String   @id @default(uuid()) @db.Uuid
  driverId   String   @map("driver_id") @db.Uuid
  shiftId    String?  @map("shift_id") @db.Uuid
  tripId     String?  @map("trip_id") @db.Uuid
  latitude   Decimal  @db.Decimal(10, 7)
  longitude  Decimal  @db.Decimal(10, 7)
  speed      Decimal? @db.Decimal(6, 2)
  recordedAt DateTime @map("recorded_at") @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  driver     User     @relation(fields: [driverId], references: [id])
  shift      Shift?   @relation(fields: [shiftId], references: [id])
  trip       Trip?    @relation(fields: [tripId], references: [id])

  @@index([driverId, recordedAt])
  @@map("location_logs")
}

model AuditLog {
  id            String   @id @default(uuid()) @db.Uuid
  actorId       String   @map("actor_id") @db.Uuid
  actionType    String   @map("action_type") @db.VarChar(50)
  entityType    String   @map("entity_type") @db.VarChar(50)
  entityId      String   @map("entity_id") @db.Uuid
  previousState Json?    @map("previous_state")
  newState      Json?    @map("new_state")
  ipAddress     String?  @map("ip_address") @db.VarChar(45)
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  actor         User     @relation("AuditActor", fields: [actorId], references: [id])

  @@index([entityType, entityId])
  @@index([actorId, createdAt])
  @@map("audit_logs")
}

model AdminConfig {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @unique @db.VarChar(100)
  value     Json
  updatedBy String?  @map("updated_by") @db.Uuid
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  updater   User?    @relation(fields: [updatedBy], references: [id])

  @@map("admin_config")
}

enum DriverVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
  FAILED_MATCH
  MANUAL_REVIEW
}

enum TripState {
  ASSIGNED
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OFFLINE_PENDING_SYNC
}
